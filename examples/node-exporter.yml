# This shops spec is suitable for running against SystemD Linux hosts such as
# Debian 10 or similar to install and ensure node-exporter from Prometheus is
# deployed and running and is the latest version.
---
version: 1

env:
  BASE_URL: https://api.github.com/repos/prometheus/node_exporter

funcs:
  get_node_exporter_binary: |
    if command -v node_exporter > /dev/null 2>&1; then
      node_exporter="node_exporter"
    else
      node_exporter="/usr/local/bin/node_exporter"
    fi

    printf "%s" "${node_exporter}"
  get_node_exporter_version: |
    $(get_node_exporter_binary) --version 2>&1 | head -n 1 | cut -d ' ' -f 3
  is_node_exporter_up_to_date: |
    latest_version="$(curl -qsSL "${BASE_URL}/releases/latest" | grep tag_name | cut -d '"' -f 4 | sed -e 's/v\(.*\)/\1/g')"
    current_version="$(get_node_exporter_version)"
    if [ "${current_version}" -eq "${latest_version}" ]; then
      return 0
    else
      return 1
    fi
  install_latest_node_exporter: |
    curl -qsSL "${BASE_URL}/releases/latest"  \
    | grep browser_download_url               \
    | grep linux.amd64                        \
    | cut -d '"' -f 4                         \
    | wget -q -O - -i -                       \
    | tar -zx node_exporter-*/node_exporter   \
    && mv node_exporter-*/node_exporter /usr/local/bin/node_exporter \
    && rm -rf node_exporter-*

items:
  - name: Ensure node_exporter is installed
    check: command -v node-exporter || test -x /usr/local/bin/node_exporter
    action: install_latest_node_exporter
  - name: Check version of node_exporter
    check: get_node_exporter_version
  - name: Ensure node_exporter is up-to-date
    check: is_node_exporter_up_to_date
    action: false
